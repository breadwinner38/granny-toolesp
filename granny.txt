--!optimization 2
loadstring(game:HttpGet("https://raw.githubusercontent.com/Sploiter13/severefuncs/refs/heads/main/merge.lua"))();

--!strict
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Camera = Workspace.CurrentCamera

-- Configuration
local UPDATE_RATE = 1.0 
local PATH_ENEMY = {"Map", "Players", "Enemy"} 
local PATH_TRAPS = {"Map", "Traps"} -- Path to Traps
local TARGET_PART_NAME = "UpperTorso" 

-- Visuals
local COLOR_TOOL = Color3.new(0, 1, 0)       -- Green (Tools)
local COLOR_TRAP = Color3.new(1, 0, 0)       -- Red (Traps)
local COLOR_ENEMY = Color3.new(1, 0, 0)      -- Red (Granny)
local OPACITY = 0.5 

-- State
local ToolCache = {} 
local TrapCache = {}
local EnemyPartCache = {} 

-- Helper: Trace folder
local function GetFolder(pathArray)
    local current = Workspace
    for _, name in ipairs(pathArray) do
        current = current:FindFirstChild(name)
        if not current then return nil end
    end
    return current
end

-- Helper: Find a physical part to track position (Generic)
local function GetTrackingPart(obj: Instance): Instance?
    local h = obj:FindFirstChild("Handle") or obj:FindFirstChild("Main")
    if h then return h end
    
    -- If it's a BasePart itself, return it
    if obj:IsA("BasePart") then return obj end

    -- Otherwise scan children
    for _, c in ipairs(obj:GetDescendants()) do
        if c:IsA("BasePart") then return c end
    end
    return nil
end

-- SCANNER LOOP
task.spawn(function()
    print("Full ESP Scanner Started...")
    while true do
        -- 1. DYNAMIC TOOL SCANNER
        local tCache = {}
        local mapFolder = Workspace:FindFirstChild("Map")
        
        if mapFolder then
            pcall(function()
                for _, location in ipairs(mapFolder:GetChildren()) do
                    local toolsContainer = location:FindFirstChild("Tools")
                    if toolsContainer then
                        for _, obj in ipairs(toolsContainer:GetDescendants()) do
                            if obj.ClassName == "Tool" or obj.ClassName == "Model" then
                                local p = GetTrackingPart(obj)
                                if p then table.insert(tCache, {Obj = obj, Part = p}) end
                            end
                        end
                    end
                end
            end)
        end
        ToolCache = tCache

        -- 2. TRAP SCANNER
        local fTraps = GetFolder(PATH_TRAPS)
        if fTraps then
            local trCache = {}
            pcall(function()
                -- Assuming traps are Models or Parts inside the Traps folder
                for _, obj in ipairs(fTraps:GetChildren()) do
                    local p = GetTrackingPart(obj)
                    if p then
                        table.insert(trCache, {Obj = obj, Part = p})
                    end
                end
            end)
            TrapCache = trCache
        else
            TrapCache = {}
        end

        -- 3. ENEMY SCANNER (UpperTorso)
        local fEnemy = GetFolder(PATH_ENEMY)
        if fEnemy then
            local eCache = {}
            pcall(function()
                local torso = fEnemy:FindFirstChild(TARGET_PART_NAME)
                if torso and torso:IsA("BasePart") then
                    table.insert(eCache, torso)
                else
                    for _, child in ipairs(fEnemy:GetDescendants()) do
                        if child.Name == TARGET_PART_NAME and child:IsA("BasePart") then
                            table.insert(eCache, child)
                            break 
                        end
                    end
                end
            end)
            EnemyPartCache = eCache
        else
            EnemyPartCache = {}
        end

        task.wait(UPDATE_RATE)
    end
end)

-- 3D MATH
local function GetCorners(cf, size)
    local pos = cf.Position
    local R, U, L = cf.RightVector, cf.UpVector, cf.LookVector
    local sx, sy, sz = size.X/2, size.Y/2, size.Z/2
    local function c(x,y,z) return pos + (R*(x*sx)) + (U*(y*sy)) + (L*(z*sz)) end
    return {
        c(1,1,1), c(-1,1,1), c(-1,-1,1), c(1,-1,1),
        c(1,1,-1), c(-1,1,-1), c(-1,-1,-1), c(1,-1,-1)
    }
end

-- RENDER LOOP
RunService.Render:Connect(function()
    local camPos = Camera.CFrame.Position

    -- 1. Draw Tools (Green Text)
    for _, data in ipairs(ToolCache) do
        local s, pos = pcall(function() return data.Part.Position end)
        if s and pos then
            local sc, vis = Camera:WorldToScreenPoint(pos)
            if vis then
                DrawingImmediate.OutlinedText(sc, 13, COLOR_TOOL, 1, data.Obj.Name, true, nil)
            end
        end
    end

    -- 2. Draw Traps (Red Text)
    for _, data in ipairs(TrapCache) do
        local s, pos = pcall(function() return data.Part.Position end)
        if s and pos then
            local sc, vis = Camera:WorldToScreenPoint(pos)
            if vis then
                DrawingImmediate.OutlinedText(sc, 13, COLOR_TRAP, 1, data.Obj.Name, true, nil)
            end
        end
    end

    -- 3. Draw Enemy (3D Box + Text)
    for _, part in ipairs(EnemyPartCache) do
        local success, cf = pcall(function() return part.CFrame end)
        local success2, size = pcall(function() return part.Size end)
        
        if success and success2 and cf and size then
            local corners = GetCorners(cf, size)
            
            -- Draw Faces
            local function DrawFace(i1, i2, i3, i4, normal)
                local center = (corners[i1] + corners[i3]) * 0.5
                local dot = vector.dot(normal, center - camPos)
                if dot < 0 then
                    local p1, v1 = Camera:WorldToScreenPoint(corners[i1])
                    local p2, v2 = Camera:WorldToScreenPoint(corners[i2])
                    local p3, v3 = Camera:WorldToScreenPoint(corners[i3])
                    local p4, v4 = Camera:WorldToScreenPoint(corners[i4])
                    if v1 or v2 or v3 or v4 then
                        DrawingImmediate.FilledQuad(
                            Vector2.new(p1.X, p1.Y), Vector2.new(p2.X, p2.Y),
                            Vector2.new(p3.X, p3.Y), Vector2.new(p4.X, p4.Y),
                            COLOR_ENEMY, OPACITY
                        )
                    end
                end
            end

            local R, U, L = cf.RightVector, cf.UpVector, cf.LookVector
            DrawFace(1, 2, 3, 4, L)
            DrawFace(6, 5, 8, 7, L * -1)
            DrawFace(1, 4, 8, 5, R)
            DrawFace(2, 6, 7, 3, R * -1)
            DrawFace(1, 5, 6, 2, U)
            DrawFace(4, 3, 7, 8, U * -1)

            -- Text
            local centerPos = cf.Position
            local screenPos, vis = Camera:WorldToScreenPoint(centerPos)
            if vis then
                local dist = vector.magnitude(camPos - centerPos)
                local offset = (1000 / dist) * (size.Y * 0.5) + 20
                local textPos = Vector2.new(screenPos.X, screenPos.Y - offset)
                DrawingImmediate.OutlinedText(textPos, 16, COLOR_ENEMY, 1, "Granny", true, nil)
            end
        end
    end
end)

print("Tool, Trap & Granny ESP Loaded.")
